<?xml version="1.0"?>
<tool id="hivtrace" name="HIV-Trace" version="1.0.0">
  <description>with options and commands</description>
  <requirements>
    <requirement type="package" version="0.1.4">hivtrace</requirement>
  </requirements>
  <command>

    hivtrace

    --input $inputfasta
    --ambiguities $runtype.ambiguities

    #if $runtype.ambiguities == "RESOLVE":
      --fraction $fraction
    #end if

    #if $reftype.reference == "Custom":
      --reference $customreference
    #else
      --reference $reference
    #end if

    --threshold $threshold
    --minoverlap $minoverlap

    #if $curate:
      --curate
    #end if

    --filter $filter

    #if $strip_drams:
      --strip_drams $strip_drams
    #end if

    #if $compare:
      --compare
    #end if

    #if $inputtype.typefasta == "aligned":
      --skip-alignment
    #end if

  </command>
  <inputs>
    <param name="inputfasta" type="data" format="fasta" label="FASTA file"/>
    <conditional name="inputtype">
      <param name="typefasta" type="select" label="Type of FASTA">
        <option value="unaligned">Unaligned</option>
        <option value="aligned">Aligned</option>
      </param>
      <when value="unaligned"/>
      <when value="aligned"/>
    </conditional>

    <conditional name="runtype">
      <param name="ambiguities" type="select" label="Handle Ambiguities">
        <sanitizer sanitize="False" />
        <option value="RESOLVE"> Resolve</option>
        <option value="AVERAGE"> Average</option>
        <option value="SKIP">    Skip</option>
        <option value="GAPMM">   GAPMM</option>
        <help>Procedure for handling IUPAC ambiguities</help>
      </param>
      <when value="AVERAGE"/>
      <when value="SKIP"/>
      <when value="GAPMM"/>
      <when value="RESOLVE">
        <param name="fraction" type="float" label="Ambiguity Fraction" value="0.05"
          help="Any sequence with no more than the selected proportion [0 - 1] will have its ambiguities resolved (if possible), and ambiguities in
                sequences with higher fractions of them will be averaged. This mitigates spurious linkages due to highly ambiguous sequences.">
          <validator type="in_range" min="0" max="1" message="Must be between 0 and 1"/>
        </param>
      </when>
    </conditional>

    <conditional name="reftype">
      <param name="reference" type="select" label="Reference Sequence">
        <sanitizer sanitize="False" />
        <option value="HXB2_pol">    HXB2_pol</option>
        <option value="NL4-3_prrt">  NL4-3_prrt</option>
        <option value="HXB2_tat">    HXB2_tat</option>
        <option value="HXB2_int">    HXB2_int</option>
        <option value="HXB2_prrt">   HXB2_prrt</option>
        <option value="HXB2_pr">     HXB2_pr</option>
        <option value="HXB2_vif">    HXB2_vif</option>
        <option value="HXB2_nef">    HXB2_nef</option>
        <option value="HXB2_vpu">    HXB2_vpu</option>
        <option value="HXB2_rev">    HXB2_rev</option>
        <option value="HXB2_vpr">    HXB2_vpr</option>
        <option value="HXB2_env">    HXB2_env</option>
        <option value="HXB2_gag">    HXB2_gag</option>
        <option value="HXB2_rt">     HXB2_rt</option>
        <option value="Custom">      Custom</option>
        <help>The sequence that will be used to align everything else to.</help>
      </param>
      <when value="HXB2_pol"/>
      <when value="NL4-3_prrt"/>
      <when value="HXB2_tat"/>
      <when value="HXB2_int"/>
      <when value="HXB2_prrt"/>
      <when value="HXB2_pr"/>
      <when value="HXB2_vif"/>
      <when value="HXB2_nef"/>
      <when value="HXB2_vpu"/>
      <when value="HXB2_rev"/>
      <when value="HXB2_vpr"/>
      <when value="HXB2_env"/>
      <when value="HXB2_gag"/>
      <when value="HXB2_rt"/>
      <when value="Custom">
        <param name="customreference" type="data" format="fasta" label="Custom reference file"/>
      </when>
    </conditional>

    <param name="threshold" type="float" label="Maximal pairwise distance [0, 0.02]" value="0.015"
      help="Two sequences will be connected with a putative link (subject to filtering), if and only if their pairwise distance does not exceed this threshold.">
      <validator type="in_range" min="0" max="0.02" message="Must be between 0 and 0.02"/>
    </param>

    <param name="minoverlap" type="float" label="Minimum pairwise overlap [50, 5000]" value="500"
      help="Only sequences who overlap by at least this many non-gap characters will be included in distance calculations. Be sure to adjust this based on the length of the input sequences.">
      <validator type="in_range" min="50" max="5000" message="Must be between 50 and 5000"/>
    </param>

    <param name="curate" type="select" label="Handle possible contaminants">
      <sanitizer sanitize="False" />
      <option value="no">       Do nothing</option>
      <option value="report">   Flag all sequences sharing a cluster with the reference</option>
      <option value="selected"> Remove all sequences sharing a cluster with the reference</option>
      <help>What should be done if query sequences belong to the same cluster as the reference. If the reference is a database/lab strain (e.g. HXB2),
            such sequences are likely mislabeled/contaminated.</help>
    </param>

    <param name="filter" type="select" label="Remove spurious connections">
      <sanitizer sanitize="False" />
      <option value="no">       Do not perform filtering</option>
      <option value="report">   Annotate spurious edges in the inferred network</option>
      <option value="selected"> Remove spurious edges from the inferred network</option>
      <help>Use a phylogenetic test of conditional independence on each triangle in the network to remove spurious <i>transitive</i> connections which make A→B→C chains look like A-B-C triangles.</help>
    </param>

    <param name="strip_drams" type="select" label="Drug resistance associated mutations">
      <sanitizer sanitize="False" />
      <option value="no">       Use all sites in pairwise distance calculations</option>
      <option value="report">   Mask (with ---) the list of codon sites defined in Lewis et al</option>
      <option value="selected"> Mask (with ---) the list of codon sites defined in Wheeler et al</option>
      <help>How to handle analyses of proteins (HIV-1 pr and/or RT only) which include drug resistance associated positions</help>
    </param>

    <param name="compare" type="boolean" label="Compare to Los Alamos National Laboratory HIV database sequences" help="Compare uploaded sequences to the all of the public sequences,
      retrieved periodically from (hiv.lanl.gov). Comparing to a public database is only available for some of the reference sequences"/>
  </inputs>
  <outputs>
    <data name="outfile" format="txt"/>
  </outputs>

  <tests>
    <test>
      <param/>
      <output/>
    </test>
  </tests>

<help>
  Placeholder help message to make planemo lint shut up
</help>
<citations>
  <citation/>
</citations>
</tool>
